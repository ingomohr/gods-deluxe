#!/bin/sh

ROOTDIR=$(cd `dirname $0`/..;pwd)

PRODUCT_NAME=Gods

music=1

case "$1" in

-no-music)
   music=0
   echo "music archive won't be created"
    ;;
-*)
    echo "unknown option $1"
    exit 1
    ;;
  *)
  ;;
  esac

version=`sed -n -e 'y/./_/' -e 's#.*STRING_VALUE = "\(.*\)".*#\1#p' $ROOTDIR/src/gods/game/Version.java`

function placehold
{
  mkdir -p $1
  echo x > $1/placeholder.txt
}

if [ ! -f "$ROOTDIR/bin/joystick.dll" ] ; then
   echo "joystick.dll not found. updating it"
   cp "$ROOTDIR/exploit/joystick.dll" "$ROOTDIR/bin"
fi

tmp_delivery_dir=/tmp/$PRODUCT_NAME

rm -rf $tmp_delivery_dir

mkdir $tmp_delivery_dir

function f_cleanup
{
cd
rm -rf $tmp_delivery_dir
rm -rf $tmp_music_dir
}
tmp_music_dir=/tmp/gods_music

mkdir -p $tmp_music_dir/Gods/music/mp3

cd "$ROOTDIR"
for i in bin icons doc fonts locale images scripts music sound tiles levels src exploit *.txt *.bat *.sh
do
cp -R "$i" $tmp_delivery_dir
done

cd /tmp

rm -rf $tmp_delivery_dir/levels/test
rm -rf $tmp_delivery_dir/levels/boss

echo "Checking for temp_start restart points in level files..."

for l in `find "$tmp_delivery_dir/levels" -name "*.glv" | sed "s# #%SPC%#g"`
do
   l="`echo $l | sed 's#%SPC%# #g'`"
   grep -w temp_start "$l" >/dev/null
   if [ $? = 0 ] ; then
      echo "Cannot create archive: temp_start found in $l"
      f_cleanup
      exit 1
   fi
done

echo "Removing backup files..."
find $tmp_delivery_dir -name "*~" -exec rm -f {} \;



cmd="mv $tmp_delivery_dir/music/mp3/levels $tmp_delivery_dir/music/mp3/title $tmp_delivery_dir/music/mp3/misc $tmp_music_dir/Gods/music/mp3"
$cmd
rm -f $tmp_delivery_dir/.gods_settings $tmp_delivery_dir/hiscores

placehold $PRODUCT_NAME/snapshots

archname=${PRODUCT_NAME}Deluxe-${version}.zip
rm -f $ROOTDIR/../$archname
echo "Creating main archive $archname..."

zip -r $ROOTDIR/../$archname $PRODUCT_NAME >/dev/null
if [ $music = 1 ] ; then
echo "Creating music archive..."
  (cd gods_music;rm -f $ROOTDIR/../${PRODUCT_NAME}_extra_music.zip;zip -r $ROOTDIR/../${PRODUCT_NAME}_extra_music.zip $PRODUCT_NAME >/dev/null)
else
  placehold $PRODUCT_NAME/music/mp3/levels
  placehold $PRODUCT_NAME/music/mp3/title
  placehold $PRODUCT_NAME/music/mp3/misc
fi

f_cleanup
