import sys,os,zipfile,re,shutil,glob
import find


MODULE_FILE = __file__
PROGRAM_DIR = os.path.abspath(os.path.dirname(MODULE_FILE))
ROOTDIR=os.path.realpath(os.path.join(PROGRAM_DIR,os.pardir))

PRODUCT_NAME="Gods"

music=False
dev=False

f = open(os.path.join(ROOTDIR,"src/gods/game/Version.java"))
contents = f.read()
f.close()

r = re.compile(r'.*STRING_VALUE\s*=\s*"(.*)".*',re.DOTALL)
g = r.match(contents)
version = g.group(1).replace(".","_")

print("making archive for version "+version)
if os.path.exists(os.path.join(ROOTDIR,"bin/joystick.dll")):
    pass
else:
    print("joystick.dll not found. updating it")
    shutil.copyfile(os.path.join(ROOTDIR,"exploit/joystick.dll"),os.path.join(ROOTDIR,"bin/joystick.dll"))

os.chdir(ROOTDIR)
archname=PRODUCT_NAME+"Deluxe-"+version+".zip"

zfn = os.path.join(ROOTDIR,os.pardir,archname)
if os.path.exists(zfn):
    os.remove(zfn)

zf = zipfile.ZipFile(zfn,mode="w",compression=zipfile.ZIP_DEFLATED)

items_list = glob.glob("*.bat")+["bin","icons","doc","fonts","locale","images","scripts","sound","tiles","levels","src","readme.txt","gods.sh"]
if dev:
    items_list+=["exploit"]

for i in items_list:
    print("processing '"+i+"'")
    if os.path.isfile(i):
        zf.write(i,arcname="Gods/"+i)
    else:
        fnd = find.Find()
        items = fnd.init(i)
        for f in items:
            if i == "levels" and (f.find("test")!=-1 or f.find("boss")!=-1):
                pass
            else:
                fi = f.replace(os.sep,"/")[2:]
                if os.path.isfile(fi):
                    if fi.endswith("~"):
                        pass
                    else:
                        if os.path.splitext(fi)[1]==".glv":
                            # check if file has "temp_start" in it
                            fh = open(fi,"r")
                            c = fh.read()
                            fh.close()
                            if c.find("temp_start")!=-1:
                                raise Exception("File %s contains a temp start" % fi)
                        zf.write(fi,arcname="Gods/"+fi)
                else:
                    zfi = zipfile.ZipInfo("Gods/"+fi+"/")
                    zf.writestr(zfi, '')

for i in ["music","snapshots","music/mp3","music/mod"]:
    zfi = zipfile.ZipInfo("Gods/"+i+"/")
    zf.writestr(zfi, '')

modn="music/mod/Gods.mod"
zf.write(modn,arcname="Gods/"+modn)

zf.close()

#rm -f $tmp_delivery_dir/.gods_settings $tmp_delivery_dir/hiscores




